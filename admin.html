<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin â€” Portfolio</title>
  <link rel="stylesheet" href="css.css" />
</head>
<body>
  <div class="bg"><div class="blob b1"></div><div class="blob b2"></div></div>

  <main class="wrap" style="max-width:760px">
    <section class="card" style="flex-direction:column;align-items:stretch">
      <h2 class="section-title">ğŸ” Espace Administrateur</h2>

      <div id="loginBlock">
        <input id="pwd" type="password" placeholder="Entrez le mot de passe" style="padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;margin-bottom:12px">
        <div style="display:flex;gap:10px">
          <button class="btn" onclick="login()">Se connecter</button>
          <button class="btn ghost" onclick="location.href='index.html'">Retour</button>
        </div>
      </div>

      <div id="adminPanel" style="display:none;margin-top:18px">
        <h3>â• Ajouter un projet</h3>

        <input id="title" placeholder="Titre du projet" style="width:100%;padding:10px;margin:6px 0;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit">
        <input id="desc" placeholder="Courte description" style="width:100%;padding:10px;margin:6px 0;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit">
        
        <div style="margin:12px 0">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
            <input type="radio" name="projectType" value="link" checked onchange="toggleProjectType()">
            Lien du projet
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
            <input type="radio" name="projectType" value="file" onchange="toggleProjectType()">
            Fichiers (optionnels)
          </label>
        </div>
        
        <!-- link -->
        <input id="link" placeholder="Lien du projet (https://...)" style="width:100%;padding:10px;margin:6px 0;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit">

        <!-- fichiers: image, video, model -->
        <div id="fileInputContainer" style="display:none">
          <label>Image (png/jpg max 5MB)</label>
          <input type="file" id="imageFile" accept="image/png,image/jpeg" style="width:100%;padding:8px;margin:6px 0;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit">
          <label>VidÃ©o (mp4 max 20MB)</label>
          <input type="file" id="videoFile" accept="video/mp4" style="width:100%;padding:8px;margin:6px 0;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit">
          <label>3D model (.glb recommandÃ©, max 30MB)</label>
          <input type="file" id="modelFile" accept=".glb" style="width:100%;padding:8px;margin:6px 0;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit">
          <p style="font-size:0.85rem;color:var(--muted);margin:4px 0">Nota: Pour affichage 3D possible dans la page, exportez depuis Blender en <strong>.glb</strong>.</p>
        </div>

        <div style="display:flex;gap:10px;margin-top:10px">
          <button class="btn" onclick="addProject()">Ajouter</button>
          <button class="btn ghost" onclick="clearAll()">Supprimer tout</button>
          <button class="btn ghost" onclick="logout()">Se dÃ©connecter</button>
        </div>

        <h3 style="margin-top:18px">Projets actuels</h3>
        <div id="currentList" style="margin-top:10px"></div>
      </div>
    </section>
  </main>

  <script>
    // ====== CONFIG ======
const BIN_URL = "https://api.jsonbin.io/v3/b/6907b238d0ea881f40cf61d7";
const API_KEY = "$2a$10$dW1U1AU6.KE748DHNfw/FeP0M2dDg7q2EeJQCC13NDruzPhmnkWOa";


    const PASSWORD = 'manar2025';

    // ====== utilitaires ======
    function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function isValidUrl(s){ try{ const u=new URL(s); return u.protocol==='http:'||u.protocol==='https:'; }catch(e){return false;} }
    async function fileToBase64(f){
      return new Promise((res,rej)=>{
        const reader = new FileReader();
        reader.onload = ()=> res(reader.result);
        reader.onerror = rej;
        reader.readAsDataURL(f);
      });
    }

    // ====== JSONBin helpers (client-side using master key) ======
    async function getProjects(){
      try{
        const res = await fetch(BIN_URL + "/latest", {
          headers: { "X-Master-Key": API_KEY }
        });
        const j = await res.json();
        return j.record || [];
      }catch(e){
        console.error(e);
        return [];
      }
    }
    async function saveProjects(arr){
      try{
        const res = await fetch(BIN_URL, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "X-Master-Key": API_KEY
          },
          body: JSON.stringify(arr)
        });
        return await res.json();
      }catch(e){
        console.error(e);
        throw e;
      }
    }

    // ====== Auth ======
    function login(){
      const v = document.getElementById('pwd').value;
      if(v === PASSWORD){
        document.getElementById('loginBlock').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
        renderList();
      } else alert('Mot de passe incorrect !');
    }
    function logout(){
      document.getElementById('pwd').value = '';
      document.getElementById('loginBlock').style.display = 'block';
      document.getElementById('adminPanel').style.display = 'none';
    }

    function toggleProjectType() {
      const projectType = document.querySelector('input[name="projectType"]:checked').value;
      const linkInput = document.getElementById('link');
      const fileInputContainer = document.getElementById('fileInputContainer');
      if (projectType === 'link') {
        linkInput.style.display = 'block';
        fileInputContainer.style.display = 'none';
      } else {
        linkInput.style.display = 'none';
        fileInputContainer.style.display = 'block';
      }
    }

    // ====== Ajout projet ======
    async function addProject(){
      const title = document.getElementById('title').value.trim();
      const desc = document.getElementById('desc').value.trim();
      const projectType = document.querySelector('input[name="projectType"]:checked').value;
      if(!title || !desc){ alert('Remplis le titre et la description !'); return; }

      let projectData = { title, desc, createdAt: new Date().toISOString() };

      if (projectType === 'link') {
        const link = document.getElementById('link').value.trim();
        if(!link || !isValidUrl(link)){ alert('Ajoute un lien valide (https://...) pour ton projet !'); return; }
        projectData.link = link;
        projectData.type = 'link';
      } else {
        // fichiers optionnels
        const imageFile = document.getElementById('imageFile').files[0];
        const videoFile = document.getElementById('videoFile').files[0];
        const modelFile = document.getElementById('modelFile').files[0];

        if(imageFile){
          if(imageFile.size > 5*1024*1024){ alert('Image trop grande (max 5MB)'); return; }
          projectData.image = await fileToBase64(imageFile);
          projectData.imageName = imageFile.name;
        }
        if(videoFile){
          if(videoFile.size > 20*1024*1024){ alert('VidÃ©o trop grande (max 20MB)'); return; }
          projectData.video = await fileToBase64(videoFile);
          projectData.videoName = videoFile.name;
        }
        if(modelFile){
          if(!modelFile.name.toLowerCase().endsWith('.glb')){ alert('TÃ©lÃ©charge un fichier 3D au format .glb (export depuis Blender).'); return; }
          if(modelFile.size > 30*1024*1024){ alert('Model trop grand (max 30MB)'); return; }
          projectData.model = await fileToBase64(modelFile);
          projectData.modelName = modelFile.name;
          projectData.type = '3d';
        }

        // si Ù…Ø§ ÙÙŠØ´ Ù…Ù„ÙØ§Øª Ù„ÙƒÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ø®ØªØ§Ø± fileØŒ Ù†Ø®Ù„ÙŠ Ø§Ù„Ù†ÙˆØ¹ link ÙØ§Ø±Øº
        if(!projectData.type) projectData.type = 'files';
      }

      // Ø­ÙØ¸ ÙÙŠ JSONBin
      let arr = await getProjects();
      arr.unshift(projectData);
      await saveProjects(arr);

      // reset form
      document.getElementById('title').value = '';
      document.getElementById('desc').value = '';
      document.getElementById('link').value = '';
      document.getElementById('imageFile').value = '';
      document.getElementById('videoFile').value = '';
      document.getElementById('modelFile').value = '';
      document.querySelector('input[name="projectType"][value="link"]').checked = true;
      toggleProjectType();

      renderList();
      alert('Projet ajoutÃ© âœ…');
    }

    // ====== Render liste admin ======
    async function renderList(){
      const list = document.getElementById('currentList');
      let arr = await getProjects();
      if(!arr || arr.length === 0){ list.innerHTML = '<p class="muted">Aucun projet enregistrÃ©.</p>'; return; }
      list.innerHTML = arr.map((p,idx)=>`
        <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 6px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px">
          <div style="flex:1">
            <strong>${escapeHtml(p.title)}</strong>
            <div class="muted" style="font-size:0.9rem">${escapeHtml(p.desc)}</div>
            ${p.type === '3d' ? '<div style="font-size:0.8rem;color:#7c4dff">ğŸ“ 3D Model</div>' : ''}
          </div>
          <div style="display:flex;gap:8px;margin-left:12px">
            ${p.model ? `<a class="btn ghost" href="${p.model}" download="${p.modelName||'model.glb'}">TÃ©lÃ©charger 3D</a>` : ''}
            ${p.image ? `<a class="btn ghost" href="${p.image}" download="${p.imageName||'image.png'}">TÃ©lÃ©charger Image</a>` : ''}
            ${p.video ? `<a class="btn ghost" href="${p.video}" download="${p.videoName||'video.mp4'}">TÃ©lÃ©charger VidÃ©o</a>` : ''}
            <button class="btn ghost" onclick="removeAt(${idx})">Suppr</button>
          </div>
        </div>
      `).join('');
    }

    async function removeAt(i){
      let arr = await getProjects();
      if(!arr[i]) return;
      if(!confirm('Supprimer ce projet ?')) return;
      arr.splice(i,1);
      await saveProjects(arr);
      renderList();
    }

    async function clearAll(){
      if(!confirm('Supprimer tous les projets ?')) return;
      await saveProjects([]);
      renderList();
      alert('Tous les projets supprimÃ©s.');
    }

    // init
    document.addEventListener('DOMContentLoaded', ()=> {
      toggleProjectType();
    });
  </script>
</body>
</html>
